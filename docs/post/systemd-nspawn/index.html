<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
        <link rel="stylesheet" href="/css/style.css?v=3">
        <link rel="stylesheet" href="/css/chroma.css?v=3">
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://fntlnz.wtf/index.xml">
        <meta property="og:url" content="https://fntlnz.wtf">
        <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png?v=2">
<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png?v=2">
<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png?v=2">
<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png?v=2">
<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png?v=2">
<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png?v=2">
<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png?v=2">
<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png?v=2">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png?v=2">
<link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png?v=2">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png?v=2">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png?v=2">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png?v=2">
<link rel="manifest" href="/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png?v=2">
<meta name="theme-color" content="#ffffff">
        
        <meta property="og:type" content="article">
        <meta property="og:title" content="Using systemd-nspawn for some containerization needs &middot; Lorenzo Fontana&#39;s Homepage">
        
        <title>Using systemd-nspawn for some containerization needs</title>
    </head>
    <body>
<header class="topBar">
Lorenzo Fontana&#39;s Homepage
</header>
 &lharu; <a href="/">back to posts list</a>
<article>
  <section id="title">
    <h1>Using systemd-nspawn for some containerization needs</h1>
    <time>Nov 14, 2016</time>
    <hr>
  </section>
  <section id="content">

<h1 id="first-things-first">First things first</h1>

<p>About one year ago, after years with Fedora 18, I refreshed my laptop and installed a brand new Fedora 22.
My first thought went to all the mess there was before the refresh because I tried tons of applications and changed my mind thousands of times
in those three years.</p>

<p>This time, I wanted to take my time to <strong>improve the process</strong> and after a few minutes thinking I had a light-bulb moment and I just started creating <strong>a Dockerfile for every application</strong> I needed !</p>

<hr />

<p>Well, after some time I had 27 images including:</p>

<ul>
<li>google-chrome</li>
<li>spotify</li>
<li>dropbox</li>
<li>NetworkManager</li>
<li>pulseaudio</li>
<li>gnome-terminal-server</li>
<li>nautilus</li>
<li>feh</li>
<li>i3wm</li>
<li>lightdm</li>
<li>crond</li>
<li>VirtualBox</li>
<li>compton</li>
<li>parcellite</li>
<li>guake</li>
<li>and&hellip; many more!</li>
</ul>

<p>As you can imagine, I started each one with the right options (<strong>I hope!</strong>) allowing it to use the X server and other resources.</p>

<p>In the next days I did some fine tuning and ended up having most of the containers I listed starting as startup system services.</p>

<h3 id="what-happened">What happened ?</h3>

<p>My computer <strong>took minutes</strong> to <strong>undefined time</strong> to boot depending on the state of the Docker daemon, and that wasn&rsquo;t acceptable for me so, sad but full of hope I started thinking at a possible solution
by identifying why Docker wasn&rsquo;t performing well as I expected in such situation.</p>

<p>The main problem, wasn&rsquo;t that the Docker daemon itself is slow (in fact it isn&rsquo;t) but a mix of factors due to the intrinsic docker&rsquo;s caracteristic that <strong>it wants to manage</strong> everything for you, like setting up namespaces for existing containers, setting up volumes, managing and connecting to plugins, mounting the layered filesystems, setting up missing network devices and so on..</p>

<p>All this obviously slows down startup times in certain situations and given the fact that I use docker <em>a lot</em> for software development and for docker development itself there are a lot of ways that the state of my machine Docker daemon is pretty messy and things are likely to be broken and slow.</p>

<h1 id="example-container-spotify">Example container: Spotify</h1>

<p>Let&rsquo;s say that I need to listen to some music and I&rsquo;m on Fedora (looks like me now :D)</p>

<p>I Google for the Spotify Linux client aaaaand that&rsquo;s IT! Spotify does have a Linux client, great!</p>

<p>Oh, damn, <strong>they only have a Debian package</strong> :(</p>

<p>&hellip;Looking for possible solutions&hellip;</p>

<p>So the first thing I did was in fact to create <strong>a Dockerfile for spotify.</strong></p>

<p><strong>Q:</strong> Wait Lorenzo, but <strong>you&rsquo;ve just said you are not using Docker</strong> for your listening needs.</p>

<p><strong>A</strong>: In fact <strong>I don&rsquo;t</strong>, I&rsquo;m just using Docker to create a Docker image, which I will export to a tar and use as a base filesystem for my container</p>

<h3 id="here-s-the-dockerfile">Here&rsquo;s the Dockerfile:</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#000080;font-weight:bold">FROM</span><span style="color:#00f"> debian:jessie</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> apt-get update -y<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys BBEBDCB318AD50EC6865090613B00F1FD2C19886<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> gpg --export --armor BBEBDCB318AD50EC6865090613B00F1FD2C19886 | apt-key add -<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> echo deb http://repository.spotify.com stable non-free | tee /etc/apt/sources.list.d/spotify.list<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> apt-get update -y<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> apt-get install spotify-client -y<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> apt-get install pulseaudio -y<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> apt-get install -f -y<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> echo enable-shm=no &gt;&gt; /etc/pulse/client.conf<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">ENV</span><span style="color:#00f"> PULSE_SERVER /run/pulse/native</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">ENV</span><span style="color:#00f"> HOME /home/spotify</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000080;font-weight:bold">RUN</span> useradd --create-home --home-dir $HOME spotify <span style="color:#00f">\
</span><span style="color:#00f"></span>  &amp;&amp; gpasswd -a spotify audio <span style="color:#00f">\
</span><span style="color:#00f"></span>  &amp;&amp; chown -R spotify:spotify $HOME<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span>  WORKDIR $HOME<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span>  USER spotify<span style="color:#a61717;background-color:#e3d2d2">
</span><span style="color:#a61717;background-color:#e3d2d2"></span>  ENTRYPOINT  [ <span style="color:#00f">&#34;spotify&#34;</span> ]</code></pre></div>
<h3 id="run-the-thing">run - the - thing</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d <span style="color:#00f">\
</span><span style="color:#00f"></span>  -v /etc/localtime:/etc/localtime:ro <span style="color:#00f">\
</span><span style="color:#00f"></span>  -v /tmp/.X11-unix:/tmp/.X11-unix <span style="color:#00f">\
</span><span style="color:#00f"></span>  -e DISPLAY=unix$DISPLAY <span style="color:#00f">\
</span><span style="color:#00f"></span>  -v /run/user/1000/pulse:/run/pulse:ro <span style="color:#00f">\
</span><span style="color:#00f"></span>  -v /var/lib/dbus:/var/lib/dbus <span style="color:#00f">\
</span><span style="color:#00f"></span>  -v $HOME/.spotify/config:/home/spotify/.config/spotify <span style="color:#00f">\
</span><span style="color:#00f"></span>  -v $HOME/.spotify/cache:/home/spotify/spotify <span style="color:#00f">\
</span><span style="color:#00f"></span>  --name spotify <span style="color:#00f">\
</span><span style="color:#00f"></span>  fntlnz/spotify</code></pre></div>
<p>Now that I have my image and I can use it with Docker seeing that it works I can try it with <code>systemd-nspawn</code></p>

<p>The first thing to do is to export the docker image to a folder we&rsquo;ll call <code>rootfs</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /var/lib/machines
cd /var/lib/machines

mkdir spotify
docker export <span style="color:#000080;font-weight:bold">$(</span>docker create fntlnz/spotify<span style="color:#000080;font-weight:bold">)</span> | tar -C spotify -xvf -</code></pre></div>
<p>Then we have to give the right permissions to <code>/home/spotify</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemd-nspawn -D spotify/ bash -c <span style="color:#00f">&#34;chown -R spotify:spotify /home/spotify&#34;</span></code></pre></div>
<p>Now each time we want to start that container we can do it with:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemd-nspawn <span style="color:#00f">\
</span><span style="color:#00f"></span>  --setenv=DISPLAY=unix$DISPLAY <span style="color:#00f">\
</span><span style="color:#00f"></span>  --bind=/tmp/.X11-unix:/tmp/.X11-unix <span style="color:#00f">\
</span><span style="color:#00f"></span>  --bind /run/user/1000/pulse:/run/pulse <span style="color:#00f">\
</span><span style="color:#00f"></span>  --bind /var/lib/dbus:/var/lib/dbus <span style="color:#00f">\
</span><span style="color:#00f"></span>  -u spotify -D spotify/ <span style="color:#00f">\
</span><span style="color:#00f"></span>  spotify</code></pre></div>
<h3 id="things-to-note">Things to note:</h3>

<ul>
<li>We haven&rsquo;t used any layered filesystem and the container is actually writing into the <code>spotify</code> directory.</li>
<li>The network stack is not isolated</li>
<li>The <strong>1000</strong> user id needs to be changed with the id of the user connected to the X session (your user id on that machine)</li>
<li>I&rsquo;m not mounting <code>$HOME/.spotify</code> things inside my <code>systemd-nspawn</code> container since I decided to keep the state in the <code>spotify</code> directory</li>
</ul>

<hr />

<h1 id="machinectl">machinectl</h1>

<p>There&rsquo;s another tool, invokable via <code>machinectl</code> which allows you to manage your &ldquo;machines&rdquo; aka containers and vms managed
by the <a href="https://wiki.freedesktop.org/www/Software/systemd/machined/"><strong>systemd machine manager</strong></a></p>

<h4 id="container-services">Container services</h4>

<p>Using machinectl you can even create startup services, for example I use this for the NetworkManagr (image not included)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">machinectl enable network-manager</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">Created symlink from /etc/systemd/system/machines.target.wants/systemd-nspawn@network-manager.service to /usr/lib/systemd/system/systemd-nspawn@.service.</pre></div>
<h4 id="management">Management</h4>

<p>machinectl allows you to list, terminate and show the status of machines.</p>

<h4 id="list-all-the-machines">List all the machines</h4>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">machinectl list</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">MACHINE CLASS     SERVICE
spotify container nspawn 

1 machines listed.</pre></div>
<h4 id="terminate-the-machine">Terminate the machine</h4>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">machinectl terminate spotify</code></pre></div>
<h4 id="get-the-status">Get the status</h4>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">machinectl status spotify</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">spotify
           Since: Mon 2016-11-14 02:13:54 CET; 7s ago
          Leader: 11308 (spotify)
         Service: nspawn; class container
            Root: /var/lib/machines/spotify
              OS: Debian GNU/Linux 8 (jessie)
            Unit: machine-spotify.scope
                  ├─11308 /usr/share/spotify/spotif
                  ├─11321 /usr/share/spotify/spotify --type=zygote --no-sandbox --lang=en-US --log-file=/usr/share/spotify/debug.log --log-severity=disable --product-version=Spotify/1.0.42.151
                  ├─11344 /proc/self/exe --type=gpu-process --channel=1.0.1413324922 --mojo-application-channel-token=7BA7725BB9581D934FDAECBCAC0E2C8B --no-sandbox --window-depth=24 --x11-visual-id=32 --lang=en-
                  └─11372 /usr/share/spotify/spotify --type=renderer --disable-pinch --no-sandbox --primordial-pipe-token=431AFC3F7268B33A8765213F7926A54A --lang=en-US --lang=en-US --log-file=/usr/share/spotify/

Nov 14 02:13:54 fntlnz systemd[1]: Started Container spotify.
Nov 14 02:13:54 fntlnz systemd[1]: Starting Container spotify.</pre></div>
<h4 id="pull-images">Pull images</h4>

<p>machinectl can pull images using <code>pull-raw</code>, <code>pull-tar</code> and <code>pull-dkr</code> from remote urls.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">machinectl pull-raw --verify=no http://ftp.halifax.rwth-aachen.de/fedora/linux/releases/21/Cloud/Images/x86_64/Fedora-Cloud-Base-20141203-21.x86_64.raw.xz
systemd-nspawn -M Fedora-Cloud-Base-20141203-21</code></pre></div>
<p>for more, see <a href="https://www.freedesktop.org/software/systemd/man/machinectl.html">machinectl</a></p>

<h2 id="what-s-next">What&rsquo;s next</h2>

<p>In this post I showed you something like the top 1% of the things that can be done with <code>systemd-nspawn</code>, there&rsquo;s <strong>moar!!</strong>, like:</p>

<ul>
<li>Usage of btrfs as container root and ephemeral containers</li>
<li>Network isolation and advanced network interfaces (macvlan, ipvlan)</li>
<li>Integration with SELinux</li>
<li>bootable images</li>
</ul>

<p>see <code>man machinectl</code> and <code>man systemd-nspawn</code> for more</p>

<hr />

<h1 id="what-i-achieved">What I achieved ?</h1>

<ul>
<li><strong>Portability and zero setup time</strong>: most linux distributions today are using systemd that means that my containers will work without having to install anything</li>
<li><strong>Faster startup times</strong>: as I said, starting just a process is faster than setting up a Docker container, not because Docker is slow (it&rsquo;s not) but because it does actually more than just starting the process</li>
<li><strong>Reuse</strong>: I can reuse any docker image I want just by exporting it to a tar file, I can even reuse virtual machine images.</li>
</ul>

<p>Now let&rsquo;s listen some music!</p>

<p><img src="/systemd-nspawn/video.gif" alt="systemd nspawn spotify" /></p>
</section>
</article>

</body>
</html>

