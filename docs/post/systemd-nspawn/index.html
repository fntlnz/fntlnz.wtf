<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Using systemd-nspawn for some containerization needs | fntlnz</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
<meta property="og:type" content="article">
<meta property="og:title" content="Using systemd-nspawn for some containerization needs &middot; fntlnz">


<meta property="og:description" content="Personal considerations on the usage of systemd-nspawn for desktop applications and system services" />

<meta property="og:url" content="https://fntlnz.wtf/post/systemd-nspawn/" />


    <header>

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://fntlnz.wtf">/home/fntlnz</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/index.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

    <link rel="apple-touch-icon" sizes="57x57" href='/favicon/apple-icon-57x57.png?v='>
<link rel="apple-touch-icon" sizes="60x60" href='/favicon/apple-icon-60x60.png?v='>
<link rel="apple-touch-icon" sizes="72x72" href='/favicon/apple-icon-72x72.png?v='>
<link rel="apple-touch-icon" sizes="76x76" href='/favicon/apple-icon-76x76.png?v='>
<link rel="apple-touch-icon" sizes="114x114" href='/favicon/apple-icon-114x114.png?v='>
<link rel="apple-touch-icon" sizes="120x120" href='/favicon/apple-icon-120x120.png?v='>
<link rel="apple-touch-icon" sizes="144x144" href='/favicon/apple-icon-144x144.png?v='>
<link rel="apple-touch-icon" sizes="152x152" href='/favicon/apple-icon-152x152.png?v='>
<link rel="apple-touch-icon" sizes="180x180" href='/favicon/apple-icon-180x180.png?v='>
<link rel="icon" type="image/png" sizes="192x192" href='/favicon/android-icon-192x192.png?v='>
<link rel="icon" type="image/png" sizes="32x32" href='/favicon/favicon-32x32.png?v='>
<link rel="icon" type="image/png" sizes="96x96" href='/favicon/favicon-96x96.png?v='>
<link rel="icon" type="image/png" sizes="16x16" href='/favicon/favicon-16x16.png?v='>
<link rel="manifest" href='/favicon/manifest.json'>
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content='/favicon/ms-icon-144x144.png?v='>
<meta name="theme-color" content="#ffffff">

  </head>
  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Using systemd-nspawn for some containerization needs</span></h1>

<h2 class="date">2016/11/14</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>


<nav id="TableOfContents">
<ul>
<li><a href="#first-things-first">First things first</a>
<ul>
<li><a href="#what-happened">What happened ?</a></li>
</ul></li>
<li><a href="#example-container-spotify">Example container: Spotify</a>
<ul>
<li><a href="#here-s-the-dockerfile">Here&rsquo;s the Dockerfile:</a></li>
<li><a href="#run-the-thing">Run the thing</a></li>
<li><a href="#additional-notes">Additional notes</a></li>
</ul></li>
<li><a href="#machinectl">machinectl</a>
<ul>
<li><a href="#container-services">Container services</a></li>
<li><a href="#management">Management</a>
<ul>
<li><a href="#list-all-the-machines">List all the machines</a></li>
<li><a href="#terminate-the-machine">Terminate the machine</a></li>
<li><a href="#get-the-status">Get the status</a>
<ul>
<li><a href="#pull-images">Pull images</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#what-s-next">What&rsquo;s next</a></li>
<li><a href="#what-i-achieved">What I achieved ?</a></li>
</ul>
</nav>


<main>


<h1 id="first-things-first">First things first</h1>

<p>About one year ago, after years with Fedora 18, I refreshed my laptop and installed a brand new Fedora 22.
My first thought went to all the mess there was before the refresh because I tried tons of applications and changed my mind thousands of times
in those three years.</p>

<p>This time, I wanted to take my time to <strong>improve the process</strong> and after a few minutes thinking I had a light-bulb moment and I just started creating <strong>a Dockerfile for every application</strong> I needed !</p>

<hr />

<p>Well, after some time I had 27 images including:</p>

<ul>
<li>google-chrome</li>
<li>spotify</li>
<li>dropbox</li>
<li>NetworkManager</li>
<li>pulseaudio</li>
<li>gnome-terminal-server</li>
<li>nautilus</li>
<li>feh</li>
<li>i3wm</li>
<li>lightdm</li>
<li>crond</li>
<li>VirtualBox</li>
<li>compton</li>
<li>parcellite</li>
<li>guake</li>
<li>and&hellip; many more!</li>
</ul>

<p>As you can imagine, I started each one with the right options (<strong>I hope!</strong>) allowing it to use the X server and other resources.</p>

<p>In the next days I did some fine tuning and ended up having most of the containers I listed starting as startup system services.</p>

<h2 id="what-happened">What happened ?</h2>

<p>My computer <strong>took minutes</strong> to <strong>undefined time</strong> to boot depending on the state of the Docker daemon, and that wasn&rsquo;t acceptable for me so, sad but full of hope I started thinking at a possible solution
by identifying why Docker wasn&rsquo;t performing well as I expected in such situation.</p>

<p>The main problem, wasn&rsquo;t that the Docker daemon itself is slow (in fact it isn&rsquo;t) but a mix of factors due to the intrinsic docker&rsquo;s caracteristic that <strong>it wants to manage</strong> everything for you, like setting up namespaces for existing containers, setting up volumes, managing and connecting to plugins, mounting the layered filesystems, setting up missing network devices and so on..</p>

<p>All this obviously slows down startup times in certain situations and given the fact that I use docker <em>a lot</em> for software development and for docker development itself there are a lot of ways that the state of my machine Docker daemon is pretty messy and things are likely to be broken and slow.</p>

<h1 id="example-container-spotify">Example container: Spotify</h1>

<p>Let&rsquo;s say that I need to listen to some music and I&rsquo;m on Fedora (looks like me now :D)</p>

<p>I Google for the Spotify Linux client aaaaand that&rsquo;s IT! Spotify does have a Linux client, great!</p>

<p>Oh, damn, <strong>they only have a Debian package</strong> :(</p>

<p>&hellip;Looking for possible solutions&hellip;</p>

<p>So the first thing I did was in fact to create <strong>a Dockerfile for spotify.</strong></p>

<p><strong>Q:</strong> Wait Lorenzo, but <strong>you&rsquo;ve just said you are not using Docker</strong> for your listening needs.</p>

<p><strong>A</strong>: In fact <strong>I don&rsquo;t</strong>, I&rsquo;m just using Docker to create a Docker image, which I will export to a tar and use as a base filesystem for my container</p>

<h2 id="here-s-the-dockerfile">Here&rsquo;s the Dockerfile:</h2>

<pre><code class="language-docker">FROM debian:jessie

RUN apt-get update -y
RUN gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys BBEBDCB318AD50EC6865090613B00F1FD2C19886
RUN gpg --export --armor BBEBDCB318AD50EC6865090613B00F1FD2C19886 | apt-key add -
RUN echo deb http://repository.spotify.com stable non-free | tee /etc/apt/sources.list.d/spotify.list
RUN apt-get update -y
RUN apt-get install spotify-client -y
RUN apt-get install pulseaudio -y
RUN apt-get install -f -y
RUN echo enable-shm=no &gt;&gt; /etc/pulse/client.conf

ENV PULSE_SERVER /run/pulse/native
ENV HOME /home/spotify

RUN useradd --create-home --home-dir $HOME spotify \
  &amp;&amp; gpasswd -a spotify audio \
  &amp;&amp; chown -R spotify:spotify $HOME

  WORKDIR $HOME
  USER spotify
  ENTRYPOINT  [ &quot;spotify&quot; ]
</code></pre>

<h2 id="run-the-thing">Run the thing</h2>

<pre><code class="language-bash">docker run -d \
  -v /etc/localtime:/etc/localtime:ro \
  -v /tmp/.X11-unix:/tmp/.X11-unix \
  -e DISPLAY=unix$DISPLAY \
  -v /run/user/1000/pulse:/run/pulse:ro \
  -v /var/lib/dbus:/var/lib/dbus \
  -v $HOME/.spotify/config:/home/spotify/.config/spotify \
  -v $HOME/.spotify/cache:/home/spotify/spotify \
  --name spotify \
  fntlnz/spotify
</code></pre>

<p>Now that I have my image and I can use it with Docker seeing that it works I can try it with <code>systemd-nspawn</code></p>

<p>The first thing to do is to export the docker image to a folder we&rsquo;ll call <code>rootfs</code></p>

<pre><code class="language-bash">mkdir -p /var/lib/machines
cd /var/lib/machines

mkdir spotify
docker export $(docker create fntlnz/spotify) | tar -C spotify -xvf -
</code></pre>

<p>Then we have to give the right permissions to <code>/home/spotify</code></p>

<pre><code class="language-bash">systemd-nspawn -D spotify/ bash -c &quot;chown -R spotify:spotify /home/spotify&quot;
</code></pre>

<p>Now each time we want to start that container we can do it with:</p>

<pre><code class="language-bash">systemd-nspawn \
  --setenv=DISPLAY=unix$DISPLAY \
  --bind=/tmp/.X11-unix:/tmp/.X11-unix \
  --bind /run/user/1000/pulse:/run/pulse \
  --bind /var/lib/dbus:/var/lib/dbus \
  -u spotify -D spotify/ \
  spotify
</code></pre>

<h2 id="additional-notes">Additional notes</h2>

<ul>
<li>We haven&rsquo;t used any layered filesystem and the container is actually writing into the <code>spotify</code> directory.</li>
<li>The network stack is not isolated</li>
<li>The <strong>1000</strong> user id needs to be changed with the id of the user connected to the X session (your user id on that machine)</li>
<li>I&rsquo;m not mounting <code>$HOME/.spotify</code> things inside my <code>systemd-nspawn</code> container since I decided to keep the state in the <code>spotify</code> directory</li>
</ul>

<hr />

<h1 id="machinectl">machinectl</h1>

<p>There&rsquo;s another tool, invokable via <code>machinectl</code> which allows you to manage your &ldquo;machines&rdquo; aka containers and vms managed
by the <a href="https://wiki.freedesktop.org/www/Software/systemd/machined/"><strong>systemd machine manager</strong></a></p>

<h2 id="container-services">Container services</h2>

<p>Using machinectl you can even create startup services, for example I use this for the NetworkManagr (image not included)</p>

<pre><code class="language-bash">machinectl enable network-manager
</code></pre>

<p>Output:</p>

<pre><code>Created symlink from /etc/systemd/system/machines.target.wants/systemd-nspawn@network-manager.service to /usr/lib/systemd/system/systemd-nspawn@.service.
</code></pre>

<h2 id="management">Management</h2>

<p>machinectl allows you to list, terminate and show the status of machines.</p>

<h3 id="list-all-the-machines">List all the machines</h3>

<pre><code class="language-bash">machinectl list

</code></pre>

<p>Output:</p>

<pre><code>MACHINE CLASS     SERVICE
spotify container nspawn 

1 machines listed.
</code></pre>

<h3 id="terminate-the-machine">Terminate the machine</h3>

<pre><code class="language-bash">machinectl terminate spotify
</code></pre>

<h3 id="get-the-status">Get the status</h3>

<pre><code class="language-bash">machinectl status spotify
</code></pre>

<p>Output:</p>

<pre><code>spotify
           Since: Mon 2016-11-14 02:13:54 CET; 7s ago
          Leader: 11308 (spotify)
         Service: nspawn; class container
            Root: /var/lib/machines/spotify
              OS: Debian GNU/Linux 8 (jessie)
            Unit: machine-spotify.scope
                  ├─11308 /usr/share/spotify/spotif
                  ├─11321 /usr/share/spotify/spotify --type=zygote --no-sandbox --lang=en-US --log-file=/usr/share/spotify/debug.log --log-severity=disable --product-version=Spotify/1.0.42.151
                  ├─11344 /proc/self/exe --type=gpu-process --channel=1.0.1413324922 --mojo-application-channel-token=7BA7725BB9581D934FDAECBCAC0E2C8B --no-sandbox --window-depth=24 --x11-visual-id=32 --lang=en-
                  └─11372 /usr/share/spotify/spotify --type=renderer --disable-pinch --no-sandbox --primordial-pipe-token=431AFC3F7268B33A8765213F7926A54A --lang=en-US --lang=en-US --log-file=/usr/share/spotify/

Nov 14 02:13:54 fntlnz systemd[1]: Started Container spotify.
Nov 14 02:13:54 fntlnz systemd[1]: Starting Container spotify.
</code></pre>

<h4 id="pull-images">Pull images</h4>

<p>machinectl can pull images using <code>pull-raw</code>, <code>pull-tar</code> and <code>pull-dkr</code> from remote urls.</p>

<pre><code class="language-bash">machinectl pull-raw --verify=no http://ftp.halifax.rwth-aachen.de/fedora/linux/releases/21/Cloud/Images/x86_64/Fedora-Cloud-Base-20141203-21.x86_64.raw.xz
systemd-nspawn -M Fedora-Cloud-Base-20141203-21
</code></pre>

<p>for more, see <a href="https://www.freedesktop.org/software/systemd/man/machinectl.html">machinectl</a></p>

<h1 id="what-s-next">What&rsquo;s next</h1>

<p>In this post I showed you something like the top 1% of the things that can be done with <code>systemd-nspawn</code>, there&rsquo;s <strong>moar!!</strong>, like:</p>

<ul>
<li>Usage of btrfs as container root and ephemeral containers</li>
<li>Network isolation and advanced network interfaces (macvlan, ipvlan)</li>
<li>Integration with SELinux</li>
<li>bootable images</li>
</ul>

<p>see <code>man machinectl</code> and <code>man systemd-nspawn</code> for more</p>

<hr />

<h1 id="what-i-achieved">What I achieved ?</h1>

<ul>
<li><strong>Portability and zero setup time</strong>: most linux distributions today are using systemd that means that my containers will work without having to install anything</li>
<li><strong>Faster startup times</strong>: as I said, starting just a process is faster than setting up a Docker container, not because Docker is slow (it&rsquo;s not) but because it does actually more than just starting the process</li>
<li><strong>Reuse</strong>: I can reuse any docker image I want just by exporting it to a tar file, I can even reuse virtual machine images.</li>
</ul>

<p>Now let&rsquo;s listen some music!</p>

<p><img src="/systemd-nspawn/video.gif" alt="systemd nspawn spotify" /></p>

</main>

    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      Just remember that you&rsquo;re awesome! | <a href="https://github.com/fntlnz">Github</a> | <a href="https://twitter.com/fntlnz">Twitter</a> | <a href="/downloads/pubkey-B2400EE4.asc">GPG Key</a>
      
    </footer>
  </body>
</html>

